# **DSP Laboratory; Week -08 Filter Analysis**

## **Aim**
Write Arduino programs for studying-
* Moving Average Filter
* Use of Auto-correlation to find the pulse rate of PPG and ECG signals


# **1. Moving Average Filter**
The moving average filter is a simple Low Pass FIR (Finite Impulse Response). It takes some samples of input and takes the mean of those to produce a single output. As the length of the filter increases, the smoothness of the output increases.
<hr />

# **2. Autocorrelation:


``` cpp
const int len=625;
const int M=4;
float ppg[len]={-0.712668672,-0.911832212,-1.028610179,-0.74426209,-0.863069078,-0.713717867,-0.520648702,-0.656235897,-0.25406834,-0.357413536,-0.149846833,0.053660732,-0.068859643,0.284883964,0.105282823,0.210610234,0.294400018,0.035710043,0.28643326,0.009246623,0.040050182,0.071974299,-0.21708006,0.011522122,-0.272198144,-0.235975465,-0.19779476,-0.468721614,-0.217554883,-0.48077987,-0.425889035,-0.361877023,-0.618812327,-0.354267674,-0.610009094,-0.54977466,-0.486973296,-0.73232257,-0.479177273,-0.726247471,-0.655629712,-0.578219047,-0.825419451,-0.548582224,-0.786344804,-0.70834636,-0.61669876,-0.84828079,-0.561304542,-0.789839624,-0.693398276,-0.593461516,-0.820128224,-0.527589791,-0.743908819,-0.642052323,-0.543110421,-0.770229707,-0.471763299,-0.700296443,-0.604940605,-0.516869822,-0.744938772,-0.465909873,-0.697722472,-0.607749641,-0.527174665,-0.763959785,-0.487692737,-0.720795759,-0.640700449,-0.563357362,-0.805450854,-0.53252131,-0.774778984,-0.695452148,-0.622408322,-0.865568307,-0.593692163,-0.826823673,-0.75285957,-0.686905544,-0.92595283,-0.651316985,-0.88667583,-0.802290195,-0.725867711,-0.955982718,-0.674960528,-0.923634337,-0.839302689,-0.749767298,-0.994532128,-0.705760855,-0.949537802,-0.861013917,-0.781162509,-1.011260062,-0.731690297,-0.97130254,-0.877087376,-0.798432998,-1.03423901,-0.749465182,-0.990497027,-0.901304383,-0.817561056,-1.05316606,-0.766113235,-0.987845195,-0.858360885,-0.711745729,-0.859626655,-0.479089338,-0.603198613,-0.409485932,-0.197492893,-0.295270139,0.121748099,0.003368142,0.187026367,0.342059587,0.155525803,0.440003695,0.189352047,0.239700211,0.27647554,-0.012943788,0.210100577,-0.08788574,-0.057078209,-0.02495663,-0.317277528,-0.079007086,-0.353146854,-0.308484891,-0.255521423,-0.521995252,-0.25546766,-0.514350981,-0.450918866,-0.381432693,-0.64471006,-0.382427619,-0.630428364,-0.569051281,-0.500924546,-0.74725831,-0.479689247,-0.719796585,-0.653391543,-0.563015398,-0.805878158,-0.523412326,-0.755170965,-0.66951254,-0.576593314,-0.803091078,-0.501253698,-0.729547932,-0.62498439,-0.526579636,-0.753719073,-0.457174765,-0.678809967,-0.584411973,-0.483906404,-0.718961403,-0.425133102,-0.652087027,-0.561766616,-0.477328629,-0.699472565,-0.428599681,-0.659507543,-0.578270152,-0.495982456,-0.737627042,-0.463739107,-0.697205766,-0.625870803,-0.551487336,-0.790507428,-0.523154723,-0.758922988,-0.679346372,-0.603997028,-0.846208077,-0.575220383,-0.81875428,-0.73502468,-0.66754563,-0.901991504,-0.626707047,-0.864263405,-0.778635863,-0.703821743,-0.946613019,-0.669842864,-0.914095316,-0.818814706,-0.731484531,-0.976846187,-0.694632639,-0.921686547,-0.850172973,-0.759306518,-0.995756097,-0.706235036,-0.947632797,-0.851929852,-0.771734055,-1.003583867,-0.719472307,-0.952188594,-0.868300642,-0.776014198,-1.015900924,-0.709621503,-0.910525663,-0.758799693,-0.581705887,-0.716565269,-0.327563745,-0.435674608,-0.208845222,0.012588026,-0.08472478,0.321178547,0.196757864,0.342673722,0.461669068,0.225418689,0.486904796,0.207533521,0.242456237,0.264863771,-0.033513082,0.189191267,-0.101718568,-0.07348497,-0.041441829,-0.323157295,-0.090943315,-0.356453921,-0.306412602,-0.247652449,-0.509799913,-0.252852762,-0.505523599,-0.437308801,-0.38208159,-0.628810188,-0.364608246,-0.615644868,-0.557573223,-0.491180031,-0.729925095,-0.457776049,-0.694297622,-0.614801917,-0.53318561,-0.760755051,-0.468940815,-0.70037996,-0.606216893,-0.509182888,-0.726083746,-0.425862123,-0.646635806,-0.546207958,-0.44013644,-0.661624492,-0.367238238,-0.589725576,-0.499606939,-0.412057891,-0.639515621,-0.349256499,-0.583675355,-0.506616148,-0.411733081,-0.643155927,-0.367553145,-0.608098156,-0.527781091,-0.450848978,-0.69721697,-0.42467544,-0.66661969,-0.599763965,-0.518458622,-0.759603104,-0.481911706,-0.73316256,-0.648592373,-0.579869229,-0.815042745,-0.541221401,-0.786446545,-0.709262266,-0.629596708,-0.872230479,-0.603054388,-0.826802482,-0.761675765,-0.681141814,-0.91587693,-0.636528735,-0.873570477,-0.782777396,-0.699122669,-0.937982958,-0.659834275,-0.891730652,-0.816193969,-0.713788079,-0.945587371,-0.667616961,-0.893366652,-0.812402331,-0.730583205,-0.957697076,-0.665898655,-0.898589229,-0.81365652,-0.736881903,-0.950596421,-0.64126353,-0.820675308,-0.655431653,-0.466792284,-0.592147587,-0.183026685,-0.27288594,-0.03397912,0.197801832,0.104498679,0.513972283,0.358970321,0.498174331,0.603771103,0.359441466,0.59555046,0.310862781,0.338743412,0.350562709,0.05068263,0.268093417,-0.0285643,0.005579577,0.043570716,-0.235941107,0.007255835,-0.260707763,-0.203053665,-0.144942285,-0.398786058,-0.140813266,-0.383058561,-0.319206592,-0.256582143,-0.51589187,-0.257740198,-0.500104938,-0.442775893,-0.370786574,-0.615161776,-0.348722511,-0.583915836,-0.507073661,-0.419848058,-0.651487384,-0.362285925,-0.579393639,-0.493928757,-0.391864684,-0.609348812,-0.309648931,-0.524985912,-0.424976354,-0.322917294,-0.546119463,-0.245961131,-0.471788587,-0.377469687,-0.292519673,-0.518044784,-0.242607065,-0.480857538,-0.403907291,-0.325130007,-0.567666651,-0.291883121,-0.532040321,-0.463227027,-0.378046751,-0.624986752,-0.357334597,-0.60010769,-0.530060698,-0.458785686,-0.697960096,-0.421212982,-0.671493406,-0.594172422,-0.514722984,-0.761274944,-0.487131028,-0.722803194,-0.651307401,-0.566039466,-0.810562119,-0.541032941,-0.7753776,-0.699333151,-0.617665597,-0.85704697,-0.576629452,-0.816303538,-0.737705901,-0.642499278,-0.882653028,-0.602338699,-0.830040826,-0.75699273,-0.672594402,-0.897190148,-0.61813662,-0.84773023,-0.763129804,-0.670410762,-0.897452897,-0.617158798,-0.859587862,-0.772044326,-0.678352566,-0.906365489,-0.621325421,-0.852970799,-0.763937101,-0.661355052,-0.84422084,-0.493866843,-0.630446124,-0.443928194,-0.241409402,-0.328149637,0.098054001,0.019094748,0.253348974,0.462316766,0.32824693,0.669762266,0.468014265,0.552006423,0.604258298,0.325796826,0.546763424,0.240075418,0.262708949,0.275043066,-0.015944528,0.206934681,-0.08934249,-0.056088099,-0.013751313,-0.282483061,-0.031979971,-0.295839166,-0.239699067,-0.172543977,-0.415890764,-0.147509195,-0.391033183,-0.332276584,-0.265214802,-0.516994204,-0.252646646,-0.510238516,-0.443269587,-0.372134466,-0.62375841,-0.348263344,-0.581828989,-0.497986606,-0.415894403,-0.637141278,-0.34623383,-0.56681364,-0.471062786,-0.373414327,-0.587030321,-0.295545016,-0.509678334,-0.411067513,-0.315756532,-0.535588993,-0.235141824,-0.470944049,-0.383479927,-0.298394866,-0.535161923,-0.259732324,-0.490103204,-0.410654891,-0.336919014,-0.580578361,-0.311150471,-0.556216371,-0.471646949,-0.408727453,-0.652061149,-0.383172646,-0.627615542,-0.55873382,-0.477362148,-0.722118296,-0.447954989,-0.693908416,-0.618040789,-0.539430645,-0.787281466,-0.50592487,-0.753788887,-0.674153469,-0.596740948,-0.831386206,-0.558018984,-0.806158778,-0.7207448,-0.645779739,-0.88372487,-0.596642551,-0.843539117,-0.74398957,-0.669126236,-0.902692928,-0.62928642,-0.860122605,-0.770252327,-0.688825565,-0.92097509,-0.631011012,-0.86402964,-0.779961097,-0.690418095,-0.925980622,-0.641288212,-0.873771974,-0.792485692,-0.699299603,-0.927753749,-0.647030537,-0.881766254,-0.798453109,-0.707892839,-0.940584676,-0.64890229,-0.879885922,-0.788815263,-0.697975398,-0.913033579,-0.599473444,-0.768773737,-0.593667769,-0.410741462,-0.525906227,-0.1166419,-0.207119029,0.024910348,0.263307105,0.165682216,0.566668247,0.40765823,0.535823858,0.6165418,0.350744654,0.59325138,0.29761176,0.3044753,0.323284394,0.016695194,0.226680521,-0.068837018,-0.044603832,-0.008711191,-0.282808069,-0.051961755,-0.314513497,-0.253607522,-0.198689763,-0.448617366,-0.188407675,-0.441526553,-0.366588226,-0.299833109,-0.557262087,-0.290306408,-0.542160727,-0.472441955,-0.406480686,-0.651905404,-0.379446176,-0.624570666,-0.538917464,-0.451601443,-0.681213793,-0.383451536,-0.614362764,-0.519947283,-0.420908136,-0.630066087,-0.338855684,-0.550942926,-0.449204089,-0.354012095,-0.573343479,-0.281447713,-0.499288967,-0.404207481,-0.322688998,-0.553372624,-0.270926827,-0.502051355};

void setup() {
// put your setup code here, to run once:
  Serial.begin(9600);
  }


void loop() {
//a) 4-point moving average filter
 
  float y[625];
  int c=0;
  for(int j=0; j<(len-4); j++){
    float sum = 0;
    for(int k=c; k<c+4; k++){
      sum= sum+ ppg[k];
    }
    y[c]= sum;
    c=c+1;
  }
  
  for(int l=0; l<4; l++){
    float sum = 0;
    for(int k=c; k<c+4-l; k++){
      sum=sum+ppg[k];
    }
    y[c]=sum;
    c=c+1;
  }

  for(int q=0;q<len;q++){
    y[q]=y[q]/4;
  }

  for(int l=0; l<len;l++){
    //Serial.print(ppg[l]);
    //Serial.print(',');
    //Serial.println(y[l]+5);

  }

//b)
  float sum=0;
  for ( int k=0;k<625;k++){
    sum=sum+y[k];
    }
    
  float mean=sum/625;

  for (int k=0;k<625;k++){
    y[k]=y[k]-mean;
    }

  int sample;
  float z[625]; //ACF
  for (int i=0;i<625;i++){
    float temp=0;
      for(int j=0;j<625-i;j++){
        temp=temp+(y[j]*y[j+i]);
      }
      z[i]=temp;
    }

  float maximum=z[0];

  for ( int o=0;o<625;o++){
    z[o]=z[o]/maximum; //Normalizing the ACF
    }

  
  for ( int i=1;i<625;i++){
    if ( (z[i-1] < z[i]) && (z[i+1] < z[i]) && z[i]>0 ) {
      sample=i;
      break;
    }
  }

  float pulserate=60*125/sample;
  Serial.print(pulserate);
  }
  
  
```
